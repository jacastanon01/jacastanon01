name: Update README
on: 
  push:
    branches:
      - 'main'
jobs:
  update_readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set Git identity
        env:
          GIT_AUTHOR_NAME: ${{ secrets.GIT_AUTHOR_NAME }}
          GIT_AUTHOR_EMAIL: ${{ secrets.GIT_AUTHOR_EMAIL }}
        run: |
          git config user.name "$GIT_AUTHOR_NAME"
          git config user.email "$GIT_AUTHOR_EMAIL"
          
      - name: Get latest changes from the repository
        run: |
          echo ${{ github.event.repository.name }}
          git fetch origin --prune --tags --force
          git checkout main
          
      - name: Update README to include repo with latest commit
        if: github.event_name == 'push' && github.event.repository.url == 'https://github.com/jacastanon01/${{ github.event.repository.name }}'
        run: |
          echo "Latest changes:" >> README.md
          for repo in $(git ls-remote --get-url); do
            echo $repo
            if [ "$repo" == "https://github.com/jacastanon01/${{ github.event.repository.name }}" ]; then
              echo "- [$repo](https://github.com/$repo)" >> README.md
            fi
          done

      - name: List last 3 commits from all repositories
        run: |
          git log -3 --format=%H --all >> README.md
          
      - name: Commit changes to README
        run: |
          git add .
          git commit -m "Update README with latest changes"
